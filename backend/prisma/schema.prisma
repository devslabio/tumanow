// TumaNow - Multi-Company Courier and Delivery Management Platform
// All IDs use UUID v4
// Multi-tenant architecture with operator isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  CREATED
  PENDING_OPERATOR_ACTION
  APPROVED
  REJECTED
  AWAITING_PAYMENT
  PAID
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  MOBILE_MONEY
  CARD
  COD
  CORPORATE
}

enum VehicleStatus {
  AVAILABLE
  ASSIGNED
  IN_TRANSIT
  MAINTENANCE
  OFFLINE
}

enum DriverStatus {
  AVAILABLE
  ASSIGNED
  BUSY
  OFFLINE
}

enum PODType {
  OTP
  PHOTO
  SIGNATURE
}

enum ItemType {
  DOCUMENTS
  SMALL_PARCEL
  ELECTRONICS
  FRAGILE
  PERISHABLES
  BULKY
}

enum DeliveryMode {
  SAME_DAY
  NEXT_DAY
  SCHEDULED
  EXPRESS
  INTERCITY
}

enum RejectionCode {
  OUT_OF_COVERAGE
  UNSUPPORTED_ITEM
  CAPACITY_EXCEEDED
  INVALID_ADDRESS
  CUSTOMER_NO_SHOW
  PAYMENT_FAILED
  SYSTEM_ERROR
}

// ============================================
// CORE TABLES
// ============================================

// Operators (Tenants) - Multi-tenant isolation
model Operator {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  name        String
  email       String?
  phone       String?
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")
  deleted_at  DateTime? @map("deleted_at")

  // Relations
  users              User[]
  vehicles           Vehicle[]
  drivers            Driver[]
  orders             Order[]
  operator_config    OperatorConfig?
  payments           Payment[]
  notifications      Notification[]

  @@index([code])
  @@index([status])
  @@map("operators")
}

// Operator Configuration (Capabilities)
model OperatorConfig {
  id                    String   @id @default(uuid()) @db.Uuid
  operator_id           String   @unique @db.Uuid
  operator              Operator @relation(fields: [operator_id], references: [id], onDelete: Cascade)

  // Item Handling
  supports_documents    Boolean  @default(false)
  supports_small_parcel Boolean  @default(false)
  supports_electronics  Boolean  @default(false)
  supports_fragile      Boolean  @default(false)
  supports_perishables  Boolean  @default(false)
  supports_bulky        Boolean  @default(false)

  // Limits
  max_weight_kg         Decimal? @db.Decimal(10, 2)
  max_dimensions_cm     String?  // JSON: {length, width, height}
  max_declared_value    Decimal? @db.Decimal(12, 2)

  // Delivery Modes
  supports_same_day     Boolean  @default(false)
  supports_next_day     Boolean  @default(false)
  supports_scheduled    Boolean  @default(false)
  supports_express      Boolean  @default(false)
  supports_intercity    Boolean  @default(false)

  // Payment Types
  supports_prepaid      Boolean  @default(true)
  supports_cod          Boolean  @default(false)
  supports_corporate    Boolean  @default(false)

  created_at            DateTime @default(now()) @map("created_at")
  updated_at            DateTime @updatedAt @map("updated_at")

  @@map("operator_configs")
}

// Users (Platform, Operator, Customer)
model User {
  id          String     @id @default(uuid()) @db.Uuid
  operator_id String?    @db.Uuid // NULL for platform users, set for operator users
  operator    Operator?  @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  name        String
  email       String?    @unique
  phone       String     @unique
  password_hash String?  @map("password_hash")
  status      UserStatus @default(ACTIVE)
  
  // Customer fields
  is_customer Boolean    @default(false) @map("is_customer")
  customer_type String?  @map("customer_type") // INDIVIDUAL, BUSINESS
  
  created_at  DateTime   @default(now()) @map("created_at")
  updated_at  DateTime   @updatedAt @map("updated_at")
  last_login  DateTime?  @map("last_login")
  deleted_at  DateTime?  @map("deleted_at")
  
  // Password reset fields
  reset_token String?    @map("reset_token")
  reset_token_expiry DateTime? @map("reset_token_expiry")

  // Relations
  user_roles  UserRole[]
  orders      Order[]    // Customer orders
  payments    Payment[]
  notifications Notification[]

  @@index([operator_id])
  @@index([email])
  @@index([phone])
  @@index([status])
  @@map("users")
}

// Roles
model Role {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique // SUPER_ADMIN, PLATFORM_SUPPORT, OPERATOR_ADMIN, etc.
  name        String
  description String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  user_roles  UserRole[]
  role_permissions RolePermission[]

  @@map("roles")
}

// User-Role Junction
model UserRole {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  role_id    String   @db.Uuid
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [role_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now()) @map("created_at")

  @@unique([user_id, role_id])
  @@index([user_id])
  @@index([role_id])
  @@map("user_roles")
}

// Permissions
model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique // e.g., "orders.create", "orders.approve"
  name        String
  description String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  // Relations
  role_permissions RolePermission[]

  @@map("permissions")
}

// Role-Permission Junction
model RolePermission {
  id           String     @id @default(uuid()) @db.Uuid
  role_id      String     @db.Uuid
  permission_id String     @db.Uuid
  role         Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)
  created_at   DateTime   @default(now()) @map("created_at")

  @@unique([role_id, permission_id])
  @@index([role_id])
  @@index([permission_id])
  @@map("role_permissions")
}

// Vehicles
model Vehicle {
  id              String        @id @default(uuid()) @db.Uuid
  operator_id     String        @db.Uuid
  operator        Operator      @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  code            String?       @unique
  plate_number    String        @unique
  make            String?       // Brand
  model           String?
  year            Int?
  color           String?
  vehicle_type    String?       @map("vehicle_type") // MOTORCYCLE, CAR, VAN, TRUCK
  capacity_kg     Decimal?       @db.Decimal(10, 2) @map("capacity_kg")
  capacity_dimensions String?   @map("capacity_dimensions") // JSON
  status          VehicleStatus @default(AVAILABLE)
  current_location_lat Decimal?   @db.Decimal(10, 7) @map("current_location_lat")
  current_location_lng Decimal? @db.Decimal(10, 7) @map("current_location_lng")
  
  created_at      DateTime      @default(now()) @map("created_at")
  updated_at      DateTime      @updatedAt @map("updated_at")
  deleted_at      DateTime?     @map("deleted_at")

  // Relations
  vehicle_drivers VehicleDriver[]
  order_assignments OrderAssignment[]

  @@index([operator_id])
  @@index([plate_number])
  @@index([status])
  @@map("vehicles")
}

// Drivers
model Driver {
  id          String       @id @default(uuid()) @db.Uuid
  operator_id String       @db.Uuid
  operator    Operator     @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  user_id     String?      @unique @db.Uuid // Link to User if driver has account
  name        String
  phone       String
  email       String?
  license_number String?   @map("license_number")
  status      DriverStatus @default(AVAILABLE)
  
  created_at  DateTime     @default(now()) @map("created_at")
  updated_at DateTime     @updatedAt @map("updated_at")
  deleted_at DateTime?    @map("deleted_at")

  // Relations
  vehicle_drivers VehicleDriver[]

  @@index([operator_id])
  @@index([phone])
  @@index([status])
  @@map("drivers")
}

// Vehicle-Driver Junction (Many-to-Many)
model VehicleDriver {
  id          String   @id @default(uuid()) @db.Uuid
  vehicle_id  String   @db.Uuid
  driver_id   String   @db.Uuid
  vehicle     Vehicle  @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  driver      Driver   @relation(fields: [driver_id], references: [id], onDelete: Cascade)
  
  is_primary  Boolean  @default(false) @map("is_primary")
  assigned_at DateTime @default(now()) @map("assigned_at")
  
  @@unique([vehicle_id, driver_id])
  @@index([vehicle_id])
  @@index([driver_id])
  @@map("vehicle_drivers")
}

// Orders
model Order {
  id                String      @id @default(uuid()) @db.Uuid
  operator_id        String      @db.Uuid
  operator           Operator    @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  customer_id       String       @db.Uuid
  customer           User        @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  
  order_number      String       @unique // Human-readable order number
  status            OrderStatus  @default(CREATED)
  
  // Pickup Details
  pickup_address    String
  pickup_lat        Decimal?     @db.Decimal(10, 7) @map("pickup_lat")
  pickup_lng        Decimal?     @db.Decimal(10, 7) @map("pickup_lng")
  pickup_contact_name String?    @map("pickup_contact_name")
  pickup_contact_phone String   @map("pickup_contact_phone")
  
  // Delivery Details
  delivery_address  String
  delivery_lat      Decimal?     @db.Decimal(10, 7) @map("delivery_lat")
  delivery_lng      Decimal?     @db.Decimal(10, 7) @map("delivery_lng")
  delivery_contact_name String?  @map("delivery_contact_name")
  delivery_contact_phone String  @map("delivery_contact_phone")
  
  // Item Details
  item_type         ItemType
  item_description  String?
  weight_kg         Decimal?     @db.Decimal(10, 2) @map("weight_kg")
  dimensions_cm     String?      // JSON: {length, width, height}
  declared_value    Decimal?     @db.Decimal(12, 2) @map("declared_value")
  is_fragile        Boolean      @default(false) @map("is_fragile")
  is_insured        Boolean      @default(false) @map("is_insured")
  
  // Delivery Mode
  delivery_mode     DeliveryMode
  scheduled_pickup_time DateTime? @map("scheduled_pickup_time")
  scheduled_delivery_time DateTime? @map("scheduled_delivery_time")
  
  // Pricing
  base_price        Decimal      @db.Decimal(12, 2) @map("base_price")
  distance_km       Decimal?     @db.Decimal(10, 2) @map("distance_km")
  surcharges        Decimal      @default(0) @db.Decimal(12, 2)
  insurance_fee     Decimal      @default(0) @db.Decimal(12, 2) @map("insurance_fee")
  total_price       Decimal      @db.Decimal(12, 2) @map("total_price")
  commission_amount Decimal      @default(0) @db.Decimal(12, 2) @map("commission_amount")
  
  // RFQ Fields (for bulky/heavy items)
  is_rfq            Boolean      @default(false) @map("is_rfq")
  rfq_quote_amount  Decimal?     @db.Decimal(12, 2) @map("rfq_quote_amount")
  rfq_approved_at   DateTime?    @map("rfq_approved_at")
  
  // Rejection
  rejection_code    RejectionCode? @map("rejection_code")
  rejection_reason  String?
  
  // POD
  pod_type          PODType?     @map("pod_type")
  pod_otp           String?      @map("pod_otp")
  pod_photo_url     String?      @map("pod_photo_url")
  pod_signature_url String?      @map("pod_signature_url")
  pod_verified_at   DateTime?    @map("pod_verified_at")
  
  created_at        DateTime      @default(now()) @map("created_at")
  updated_at        DateTime      @updatedAt @map("updated_at")
  deleted_at        DateTime?    @map("deleted_at")

  // Relations
  order_history     OrderHistory[]
  order_assignments OrderAssignment[]
  payments          Payment[]
  tracking_events   TrackingEvent[]

  @@index([operator_id])
  @@index([customer_id])
  @@index([order_number])
  @@index([status])
  @@index([created_at])
  @@map("orders")
}

// Order Assignment (Vehicle-based)
model OrderAssignment {
  id          String   @id @default(uuid()) @db.Uuid
  order_id    String   @db.Uuid
  vehicle_id String   @db.Uuid
  driver_id   String?  @db.Uuid // Optional, can be assigned later
  order       Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  vehicle     Vehicle  @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  
  assigned_at DateTime @default(now()) @map("assigned_at")
  assigned_by String?  @map("assigned_by") // User ID who assigned
  
  @@index([order_id])
  @@index([vehicle_id])
  @@index([driver_id])
  @@map("order_assignments")
}

// Order History (Audit Trail)
model OrderHistory {
  id          String      @id @default(uuid()) @db.Uuid
  order_id    String      @db.Uuid
  order       Order       @relation(fields: [order_id], references: [id], onDelete: Cascade)
  
  status_from OrderStatus @map("status_from")
  status_to   OrderStatus @map("status_to")
  changed_by  String?     @map("changed_by") // User ID
  notes       String?
  
  created_at  DateTime    @default(now()) @map("created_at")

  @@index([order_id])
  @@index([created_at])
  @@map("order_history")
}

// Payments
model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  operator_id     String        @db.Uuid
  operator        Operator      @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  order_id        String        @db.Uuid
  order           Order         @relation(fields: [order_id], references: [id], onDelete: Cascade)
  
  customer_id     String        @db.Uuid
  customer        User          @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  
  amount          Decimal       @db.Decimal(12, 2)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  
  transaction_id  String?       @unique @map("transaction_id")
  gateway_response String?      @map("gateway_response") // JSON
  
  paid_at         DateTime?     @map("paid_at")
  created_at      DateTime      @default(now()) @map("created_at")
  updated_at      DateTime      @updatedAt @map("updated_at")

  @@index([operator_id])
  @@index([order_id])
  @@index([customer_id])
  @@index([status])
  @@index([transaction_id])
  @@map("payments")
}

// Tracking Events
model TrackingEvent {
  id          String   @id @default(uuid()) @db.Uuid
  order_id    String   @db.Uuid
  order       Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  
  status      OrderStatus
  location_lat Decimal? @db.Decimal(10, 7) @map("location_lat")
  location_lng Decimal? @db.Decimal(10, 7) @map("location_lng")
  notes       String?
  
  created_at  DateTime @default(now()) @map("created_at")

  @@index([order_id])
  @@index([created_at])
  @@map("tracking_events")
}

// Notifications
model Notification {
  id          String   @id @default(uuid()) @db.Uuid
  operator_id String?  @db.Uuid
  operator    Operator? @relation(fields: [operator_id], references: [id], onDelete: Cascade)
  
  user_id     String   @db.Uuid
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  type        String   // ORDER_CREATED, ORDER_APPROVED, PAYMENT_RECEIVED, etc.
  title       String
  message     String
  data        String?  // JSON
  
  // Channels
  sent_email  Boolean  @default(false) @map("sent_email")
  sent_sms    Boolean  @default(false) @map("sent_sms")
  sent_push   Boolean  @default(false) @map("sent_push")
  sent_in_app Boolean  @default(false) @map("sent_in_app")
  
  read_at     DateTime? @map("read_at")
  created_at  DateTime  @default(now()) @map("created_at")

  @@index([operator_id])
  @@index([user_id])
  @@index([created_at])
  @@map("notifications")
}

// Audit Logs
model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  operator_id String?  @db.Uuid // NULL for platform actions
  
  user_id     String?  @db.Uuid
  action      String   // CREATE, UPDATE, DELETE, APPROVE, etc.
  entity_type String   @map("entity_type") // Order, User, Vehicle, etc.
  entity_id   String   @map("entity_id")
  changes     String?  // JSON diff
  ip_address  String?  @map("ip_address")
  
  created_at  DateTime @default(now()) @map("created_at")

  @@index([operator_id])
  @@index([user_id])
  @@index([entity_type, entity_id])
  @@index([created_at])
  @@map("audit_logs")
}

